
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../installation/">
      
      
        <link rel="next" href="../cookbook/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Tutorial - lightcurver</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
  
  <style>:root{--md-admonition-icon--<type>:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M13%2013h-2V7h2m0%2010h-2v-2h2M12%202A10%2010%200%200%200%202%2012a10%2010%200%200%200%2010%2010%2010%2010%200%200%200%2010-10A10%2010%200%200%200%2012%202%22/%3E%3C/svg%3E');}</style>


  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M17%2013h-4v4h-2v-4H7v-2h4V7h2v4h4m-5-9A10%2010%200%200%200%202%2012a10%2010%200%200%200%2010%2010%2010%2010%200%200%200%2010-10A10%2010%200%200%200%2012%202%22/%3E%3C/svg%3E');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lightcurver-tutorial" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="lightcurver" class="md-header__button md-logo" aria-label="lightcurver" data-md-component="logo">
      
  <img src="../lightcurver_logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            lightcurver
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/duxfrederic/lightcurver/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="lightcurver" class="md-nav__button md-logo" aria-label="lightcurver" data-md-component="logo">
      
  <img src="../lightcurver_logo.svg" alt="logo">

    </a>
    lightcurver
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/duxfrederic/lightcurver/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-the-working-directory-and-data" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing the working directory and data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-database-and-frame-importation" class="md-nav__link">
    <span class="md-ellipsis">
      Initializing database and frame importation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plate-solving-and-footprint-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Plate solving and footprint calculation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-stars-from-gaia" class="md-nav__link">
    <span class="md-ellipsis">
      Querying stars from Gaia
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extraction-of-cutouts" class="md-nav__link">
    <span class="md-ellipsis">
      Extraction of cutouts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-the-psf" class="md-nav__link">
    <span class="md-ellipsis">
      Modelling the PSF
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#psf-photometry-of-the-reference-stars" class="md-nav__link">
    <span class="md-ellipsis">
      PSF photometry of the reference stars
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calculating-a-normalization-coefficient" class="md-nav__link">
    <span class="md-ellipsis">
      Calculating a normalization coefficient
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calculating-zero-points-and-preparing-calibrated-cutouts-of-our-region-of-interest" class="md-nav__link">
    <span class="md-ellipsis">
      Calculating zero points and preparing calibrated cutouts of our region of interest
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-the-roi" class="md-nav__link">
    <span class="md-ellipsis">
      Modelling the ROI
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cookbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cookbook
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-the-working-directory-and-data" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing the working directory and data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initializing-database-and-frame-importation" class="md-nav__link">
    <span class="md-ellipsis">
      Initializing database and frame importation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#plate-solving-and-footprint-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Plate solving and footprint calculation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-stars-from-gaia" class="md-nav__link">
    <span class="md-ellipsis">
      Querying stars from Gaia
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extraction-of-cutouts" class="md-nav__link">
    <span class="md-ellipsis">
      Extraction of cutouts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-the-psf" class="md-nav__link">
    <span class="md-ellipsis">
      Modelling the PSF
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#psf-photometry-of-the-reference-stars" class="md-nav__link">
    <span class="md-ellipsis">
      PSF photometry of the reference stars
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calculating-a-normalization-coefficient" class="md-nav__link">
    <span class="md-ellipsis">
      Calculating a normalization coefficient
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calculating-zero-points-and-preparing-calibrated-cutouts-of-our-region-of-interest" class="md-nav__link">
    <span class="md-ellipsis">
      Calculating zero points and preparing calibrated cutouts of our region of interest
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-the-roi" class="md-nav__link">
    <span class="md-ellipsis">
      Modelling the ROI
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lightcurver-tutorial"><code>lightcurver</code> tutorial</h1>
<div class="annotate">
<h2 id="introduction">Introduction</h2>
<p>By default, <code>lightcurver</code> is a pipeline which executes all its steps sequentially, 
through the <code>lightcurver.pipeline.workflow_manager.WorkflowManager</code> class.
So, the most basic python script executing the pipeline would be as follows:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LIGHTCURVER_CONFIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/path/to/config.yaml&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.pipeline.workflow_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkflowManager</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">wf_manager</span> <span class="o">=</span> <span class="n">WorkflowManager</span><span class="p">()</span>
    <span class="n">wf_manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>Where the <code>config.yaml</code> file needs to be carefully tuned before execution. You should always start from 
<a href="https://github.com/duxfrederic/lightcurver/blob/main/lightcurver/pipeline/example_config_file/config.yaml">this template</a>.</p>
<p>You can also run the script above directly from the command line with the following command:
<div class="highlight"><pre><span></span><code>lc_run<span class="w"> </span>/path/to/config.yaml
</code></pre></div></p>
<p><code>lc_run -h</code> will print the following list of steps performed by the pipeline:
<div class="highlight"><pre><span></span><code>read_convert_skysub_character_catalog
plate_solving
calculate_common_and_total_footprint
query_gaia_for_stars
stamp_extraction
psf_modeling
star_photometry
calculate_normalization_coefficient
calculate_absolute_zeropoints
prepare_calibrated_cutouts
model_calibrated_cutouts
</code></pre></div>
The pipeline is incremental, but in certain cases it might be useful to start or stop the pipeline at given steps, 
for example: this will run the extraction of the cutouts and the modelling of the PSF only.
<div class="highlight"><pre><span></span><code>lc_run<span class="w"> </span>/path/to/config.yaml<span class="w"> </span>--start<span class="w"> </span>stamp_extraction<span class="w"> </span>--stop<span class="w"> </span>psf_modeling
</code></pre></div>
This will only run the modelling of the ROI:
<div class="highlight"><pre><span></span><code>lc_run<span class="w"> </span>/path/to/config.yaml<span class="w"> </span>--start<span class="w"> </span>model_calibrated_cutouts
</code></pre></div></p>
<p>In this tutorial, to understand the role of the different steps, 
we will first execute each step manually rather than executing the pipeline through the <code>WorkflowManager</code>.</p>
<p>I will provide you with some wide field images that you can use to follow along. Note the following:</p>
<ul>
<li>The images are already plate solved, such that you will not need to install <code>Astrometry.net</code> on your computer.
Your real life examples will most likely not be, so you should consider installing it.</li>
<li>Things will be excruciatingly slow if you do not have a GPU. I would consider using only 4-5 frames in this case.</li>
</ul>
<p>You can work in a jupyter notebook or just write python scripts with the commands we will execute below.</p>
<div class="admonition warning">
<p class="admonition-title">Running lightcurver function calls in python scripts</p>
<p>On Mac and Windows computers, you would need to wrap all your function calls in a <code>if __name__ == "__main__"</code> block. 
These are omitted in the code snippets below for brevity, but you will get an error due to the way multiprocessing
spawns processes on Mac and Windows if you don't.</p>
</div>
<h2 id="preparing-the-working-directory-and-data">Preparing the working directory and data</h2>
<p>The example dataset consists of a few frames from the monitoring of a lensed quasar with the VLT Survey Telescope (VST).
You can find it at this <a href="https://www.astro.unige.ch/~dux/vst_dataset_example.zip">link</a>, but we will download it below anyway.
Start by creating a working directory. I will assume the working directory <code>/scratch/lightcurver_tutorial</code>, please
replace this with your own.
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">workdir</span><span class="o">=</span><span class="s1">&#39;/scratch/lightcurver_tutorial&#39;</span>
mkdir<span class="w"> </span><span class="nv">$workdir</span>
</code></pre></div>
Let us store our raw data in this working directory as well for the sake of the example, but of course it could be
anywhere, including on a network drive.
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="nv">$workdir</span>
wget<span class="w"> </span>https://www.astro.unige.ch/~dux/vst_dataset_example.zip
unzip<span class="w"> </span>vst_dataset_example.zip
</code></pre></div>
Your data will now be at <code>/scratch/lightcurver_tutorial/raw</code>, here is what a single frame looks like, with the region
of interest marked:
<img alt="single_frame_wide_field.jpg" src="../single_frame_wide_field.jpg" /></p>
<p>The pipeline also expects a function able to read the header of your fits files. Store the following python function:
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_header</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">dateutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">parser</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
    <span class="n">exptime</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;obstart&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;exptime&#39;</span><span class="p">:</span> <span class="n">exptime</span><span class="p">,</span> <span class="s1">&#39;gain&#39;</span><span class="p">:</span> <span class="n">gain</span><span class="p">,</span> <span class="s1">&#39;mjd&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">mjd</span><span class="p">}</span>
</code></pre></div>
in this file: <code>$workdir/header_parser/parse_header.py</code>. 
The pipeline expects to find this file at this exact location relative to your working directory.
You will need to adapt the function to your own fits files, the point is: you must return a dictionary of the same
structure as the one seen above. </p>
<div class="admonition note">
<p class="admonition-title">Units of your data</p>
<p>We will use the <code>exptime</code> and <code>gain</code> information to convert the images to electrons per second, assuming that the starting unit is ADU. 
Please adapt the values you return within this function should your units be different.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Time units</p>
<p>We correct for the proper motion of stars when extracting cutouts later in the pipeline,
so you need to stick to providing time information (<code>mjd</code>) as Modified Julian Days.</p>
</div>
<p>Now, we need to set up the configuration file of the pipeline. This file could be anywhere, but we will put it in
our working directory. 
I provide a <a href="https://github.com/duxfrederic/lightcurver/blob/main/lightcurver/pipeline/example_config_file/config.yaml">fairly generic configuration</a> 
which works well for this particular dataset.
Paste the contents of the file in <code>$workdir/config.yaml</code>.
You will most probably need to adapt these lines at least:
<div class="highlight"><pre><span></span><code><span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/scratch/lightcurver_tutorial</span><span class="w"> </span>
<span class="c1"># ...</span>
<span class="nt">raw_dirs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/scratch/lightcurver_tutorial/raw</span>
<span class="c1"># further below ...</span>
<span class="nt">already_plate_solved</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
This last line informs the pipeline about the plate solved status of our files.
You can also read through the configuration file to learn about the different options of the pipeline.</p>
<p>At any point, you could just run the code block at the very beginning of this page, and the pipeline would likely
run to the end, producing an <code>hdf5</code> file with calibrated cutouts and PSFs of our region of interest.
We will keep executing each step separately however, so you get a chance to look at the outputs.</p>
<h2 id="initializing-database-and-frame-importation">Initializing database and frame importation</h2>
<p>Now would be a good time to fire up a jupyter notebook, each code block below being a new cell.
You first need to add the location of your config file to the environment, then you can start executing tasks:
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1"># replace with your actual path:</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LIGHTCURVER_CONFIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/scratch/lightcurver_tutorial/config.yaml&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.structure.user_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_user_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.structure.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">initialize_database</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.pipeline.task_wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_convert_skysub_character_catalog</span>

<span class="n">initialize_database</span><span class="p">()</span>
<span class="n">read_convert_skysub_character_catalog</span><span class="p">()</span>
</code></pre></div></p>
<p>This last command will read all the frames, convert them to electron / second (we are assuming ADU as initial units),
subtract the sky, look for sources in the image, calculate ephemeris and finally store everything in our database, at
<code>/scratch/lightcurver_tutorial/database.sqlite3</code>.</p>
<div class="admonition database queries">
<p class="admonition-title">Database</p>
<p>You may query the database at any time to understand what is going on.
For example, at the moment we have:
<div class="highlight"><pre><span></span><code><span class="w"> </span>$<span class="w"> </span>sqlite3<span class="w"> </span><span class="nv">$workdir</span>/database.sqlite3<span class="w"> </span><span class="s2">&quot;select count(*) from frames&quot;</span>
<span class="w"> </span><span class="m">87</span>
</code></pre></div>
The database contains the frames, and later will contain stars, links between stars and frames, and more.</p>
</div>
<h2 id="plate-solving-and-footprint-calculation">Plate solving and footprint calculation</h2>
<p>Even though we started with plate solved images, we are still going to call the plate solving routine.
No actual plate solving will take place, but the footprint of each image will be inserted in the database,
and we will calculate the total and common footprint to all images. This can be useful if you want to make sure
that you are always going to use the same reference stars, in each frame. 
Let us go ahead and run the task:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Assuming the path to the config file is still in the environment.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.pipeline.task_wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="n">plate_solve_all_frames</span><span class="p">,</span> <span class="n">calc_common_and_total_footprint_and_save</span>
<span class="n">plate_solve_all_frames</span><span class="p">()</span> <span class="c1"># (7)</span>
<span class="n">calc_common_and_total_footprint_and_save</span><span class="p">()</span>
</code></pre></div>
<p>This will have populated the <code>footprints</code> and <code>combined_footprint</code> tables of the database.</p>
<div class="admonition warning">
<p class="admonition-title">Footprint shenanigans</p>
<p>All downstream steps from this one are linked to a hash value of the combined footprint.
If your Gaia stars selection of the next section is made with the <code>ROI_disk</code> strategy, the hash value
bypasses the actual footprint and is simply set to the radius of the disk. Thus, adding new frames will not 
trigger the reprocessing of everything (but changing the radius will).</p>
</div>
<p>At this point, you can open the <code>footprints.jpg</code> diagnostic plot which might look something like the following.</p>
<p><img alt="footprints_plot_example.jpg" src="../footprints_plot_example.jpg" /></p>
<p>Note that the pipeline eliminates the pointings (sets <code>ROI_in_footprint = 0</code>) in the frames table of the database) 
that do not contain your region of interest, these are not shown in the diagnostic plot.</p>
<h2 id="querying-stars-from-gaia">Querying stars from Gaia</h2>
<p>Back to the configuration file, I recommend using
<div class="highlight"><pre><span></span><code><span class="nt">star_selection_strategy</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ROI_disk&#39;</span>
<span class="nt">ROI_disk_radius_arcseconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300 (1)</span>
</code></pre></div></p>
<p>Next, depending on your data, you will need to adjust the acceptable magnitude range (to include stars that are
bright enough while not saturating the sensor.)
If you have good seeing and are working with oversampled data, I recommend sticking to a relatively low value of
<code>star_max_astrometric_excess_noise</code>. Gaia can sometimes mistake a galaxy for a star, and a galaxy would do no
good to your PSF model. Keeping the astrometric excess noise low (e.g., below 3-4) largely reduces the risk
of selecting a galaxy.
This is how this part is executed:
<div class="highlight"><pre><span></span><code><span class="c1"># assuming the path to the config file is still in the environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.star_querying</span><span class="w"> </span><span class="kn">import</span> <span class="n">query_gaia_stars</span>
<span class="n">query_gaia_stars</span><span class="p">()</span>
</code></pre></div>
This will populate the <code>stars</code> and <code>stars_in_frames</code> tables of the database. The latter allows us to query
which star is available in which frame.</p>
<p>The plot you can look at to make sure things look reasonable is <code>footprints_with_gaia_stars.jpg</code>, which might look something like this:</p>
<p><img alt="footprints_with_gaia_stars_plot_example.jpg" src="../footprints_with_gaia_stars_plot_example.jpg" /></p>
<h2 id="extraction-of-cutouts">Extraction of cutouts</h2>
<p>Now that we've identified stars, let us extract them from the image. This step will</p>
<ul>
<li>extract the cutouts,</li>
<li>compute a noisemap (from the background noise, and photon noise estimation given that we can convert our data to electrons),</li>
<li>clean the cosmics (unless stated otherwise in the config),</li>
</ul>
<p>and those for each selected star, and also for our region of interest.
These will all go into the <code>regions.h5</code> file, at the root of the working directory.
This is this step is called:
<div class="highlight"><pre><span></span><code><span class="c1"># assuming the path to the config file is still in the environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.cutout_making</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_all_stamps</span>
<span class="n">extract_all_stamps</span><span class="p">()</span>
</code></pre></div></p>
<p>Here is a snippet to see what the cutouts look like:
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;regions.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">frames</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;frames&#39;</span><span class="p">]</span>  <span class="c1"># main set is called frames</span>
    <span class="n">frame</span> <span class="o">=</span> <span class="n">frames</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;frames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">]]</span>  <span class="c1"># listing the frames and picking one.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">frame</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>  <span class="c1"># looking at data, but you can also go for `mask` or `noisemap`</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="c1"># keep just the last 5</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="n">objs</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">objs</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">objs</span><span class="p">,</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">obj</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<img alt="cutouts.png" src="../cutouts.png" /></p>
<h2 id="modelling-the-psf">Modelling the PSF</h2>
<p>This is the most expensive step of the pipeline. For each frame, we are going to simultaneously fit a
grid of pixels to all the selected stars. The grid of pixels being regulated by starlets, we delegate the heavy 
lifting to <code>STARRED</code>.
I recommend sticking to a subsampling factor of 2 unless you have good reasons to go beyond this.
You can expect the process to last 2-3 seconds per frame on a middle range gaming GPU, including the loading of the data,
the modelling, the plotting, and database update.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># assuming the path to the config file is still in the environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.psf_modelling</span><span class="w"> </span><span class="kn">import</span> <span class="n">model_all_psfs</span>
<span class="n">model_all_psfs</span><span class="p">()</span>
</code></pre></div>
<p>This will populate the <code>PSFs</code> table in the database, saving the subsampling factor, the reduced chi-squared of the fit,
and some text reminding which stars were used to compute the model.
You can check the plots at <code>$workdir/plots/PSFs/</code>, here is an example:</p>
<p><img alt="psf_plot_example.jpg" src="../psf_plot_example.jpg" /></p>
<p>The plot shows all the stars that contributed to the PSF models and their noisemaps. 
The last row shows the fit residuals after subtraction of the model, in units of the noise.
The last column shows the loss curve of the fit, as well as the PSF model.
You might want to skim through some of the PSF plots to make sure there isn't something fishy.
If you notice that a star is causing problems in particular, you can exclude it by defining what stars
the PSF model can use in the config file.
For example, say we need to eliminate star <code>a</code> in the plot above, we'd set:
<div class="highlight"><pre><span></span><code><span class="nt">stars_to_use_psf</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bcdefghijklmnop</span>
</code></pre></div>
Then you'd have to re-run the PSF process with <code>redo_psf: true</code>.</p>
<h2 id="psf-photometry-of-the-reference-stars">PSF photometry of the reference stars</h2>
<p>This step will, for each star</p>
<ul>
<li>select which frames contain this star</li>
<li>eliminate frames with a poorly fit PSF (looking at the reduced chi-squared values, check the config file for how this is done)</li>
<li>jointly fit the PSF to the star in question in all the selected frames.</li>
</ul>
<p><div class="highlight"><pre><span></span><code><span class="c1"># assuming the path to the config file is still in the environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.star_photometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">do_star_photometry</span>
<span class="n">do_star_photometry</span><span class="p">()</span>
</code></pre></div>
The fitted fluxes will be saved in the <code>star_flux_in_frame</code> table, together with, again, a reduced chi-squared value that
will be used downstream to eliminate the badly fitted frames.
Again it is a good idea to check the diagnostic plot, one of which is generated per star.
<img alt="starphotom_plot_example.jpg" src="../starphotom_plot_example.jpg" /></p>
<p>From left to right, we have the mean (stack) of all the cutouts of that stared that went into the PSF photometry,
the stacked residuals after subtraction from the fitted model, once in data and once in noise units, the loss curve, and the distribution
of reduced chi-squared values of the fit on individual frames.</p>
<h2 id="calculating-a-normalization-coefficient">Calculating a normalization coefficient</h2>
<p>This step leverages all the extracted star fluxes, and scales them as to minimize the scatter of the fluxes of
different stars in overlaping frames.
Once this is done, the fluxes available in each frame will be averaged with sigma-clipping rejection.
The average will be taken as the "normalization coefficient", and the residual scatter as the uncertainty on the
coefficient.</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># assuming the path to the config file is still in the environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.normalization_calculation</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_coefficient</span>
<span class="n">calculate_coefficient</span><span class="p">()</span>
</code></pre></div>
This process fills in the <code>normalization_coefficients</code> table.
You can check that the normalization is indeed appropriately flattening the curves of your reference star in the
diagnostic plot:</p>
<p><img alt="norm_coeff_plot_example.png" src="../norm_coeff_plot_example.png" /></p>
<p>At the top the normalization coefficient, per frame, plotted in function of the frame. At the bottom the
light curve of one of the reference stars.</p>
<h2 id="calculating-zero-points-and-preparing-calibrated-cutouts-of-our-region-of-interest">Calculating zero points and preparing calibrated cutouts of our region of interest</h2>
<p>All the heavy lifting having been done, we can use our Gaia stars to estimate the absolute zero point of our images.
You can also specify another survey to use for this calibration in the config file.</p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># assuming the path to the config file is still in the environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.absolute_zeropoint_calculation</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_zeropoints</span>

<span class="n">calculate_zeropoints</span><span class="p">()</span>
</code></pre></div>
Next, we use our normalization coefficient to prepare the calibrated cutouts.
<div class="highlight"><pre><span></span><code><span class="c1"># assuming the path to the config file is still in the environment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.roi_file_preparation</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_roi_file</span>
<span class="n">prepare_roi_file</span><span class="p">()</span>
</code></pre></div>
You will find your calibrated cutouts in the <code>prepared_roi_cutouts</code>, relative to the working directory.</p>
<h2 id="modelling-the-roi">Modelling the ROI</h2>
<p>The last and most satisfying step!
As a reminder, <code>STARRED</code> jointly models all your epochs at once. It does so by modelling the data
as the sum of point sources (whose flux can vary from epoch to epoch) and a pixelated background regularized by wavelets.
This part is highly non-linear, and you could follow one of the <code>STARRED</code> tutorials to model your cutouts yourself.
Nevertheless, the pipeline does have a modelling step that works for simple cases, so we can also take a look at the available parameters.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Simple cases: pipeline script</label><label for="__tabbed_1_2">Manual modelling</label><label for="__tabbed_1_3">Combining the two</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>(Check the annotation buttons for comments)</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">do_ROI_model</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true (2)</span>
<span class="nt">point_sources</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">(3)</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">A</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">42.202991</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">19.225400</span><span class="p p-Indicator">]</span>
<span class="w">   </span><span class="nt">B</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">42.202944</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">19.225186</span><span class="p p-Indicator">]</span>
<span class="w">   </span><span class="nt">C</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">42.203227</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">19.225010</span><span class="p p-Indicator">]</span>
<span class="w">   </span><span class="nt">D</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">42.203249</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">19.225389</span><span class="p p-Indicator">]</span>

<span class="c1"># so, null or a path for this one (path either relative to workdir, or absolute path starting with /):</span>
<span class="nt">starting_background</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null (4)</span>
<span class="c1"># if null above, and false here, then you will not include a background (kinda ruining the point of the entire pipeline, but well...)</span>
<span class="nt">further_optimize_background</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true (5)</span>

<span class="c1"># and these should mostly work as is, how many iterations of the optimizer do we do?</span>
<span class="nt">roi_deconv_translations_iters</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300 (6)</span>
<span class="nt">roi_deconv_all_iters</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000</span>
<span class="c1"># keep in mind that this is going to be relatively slow on a CPU. (a few minutes at least). Count 30min for the whole pipeline.</span>
</code></pre></div>
When you are satisfied with the settings, run the modelling step:
<div class="highlight"><pre><span></span><code>  <span class="kn">from</span><span class="w"> </span><span class="nn">lightcurver.processes.roi_modelling</span><span class="w"> </span><span class="kn">import</span> <span class="n">do_modelling_of_roi</span>
  <span class="n">do_modelling_of_roi</span><span class="p">()</span>
</code></pre></div></p>
<p>And now, in the <code>prepared_roi_cutouts</code> directory you should have </p>
<ul>
<li>a <code>csv</code> file containing the fluxes and uncertainties of each point source at each epoch,
as well as additional information (MJD, seeing, reduced chi-squared, zeropoint so you can convert the fluxes to magnitudes, database ID
of the frame),</li>
<li>a <code>json</code> file containing the astrometry of the point sources,</li>
<li>two fits files containing the fitted high resolution model product, once with point sources and once with the background only.</li>
</ul>
</div>
<div class="tabbed-block">
<p>For more control over the point sources and background, we can manually conduct a <code>STARRED</code> modelling on the cutouts we prepared.
Please see <a href="https://github.com/duxfrederic/lightcurver/blob/main/docs/example_starred_notebooks/example_roi_modelling.ipynb">this example</a>,
which is quite versatile.</p>
</div>
<div class="tabbed-block">
<p>The idea is to setup the right modelling steps once, for example in a <code>jupyter</code> notebook, then save
the notebook as a python script.
Then, one can simply run the resulting script at the end of every execution of the pipeline.</p>
</div>
</div>
</div>
</div>
<ol>
<li>Think twice about this value: it has to contain enough stars, but not too many either. Aim for ~20 stars, look at one 
of your images and do a rough inventory of what is available within a certain distance from your region of interest.</li>
<li>You can set this to false if you are going to do the reduction yourself, or if you do not want the pipeline to waste time
redoing this everytime. (This is not an incremental step, all the frames are jointly modelled.)</li>
<li>Here, you can give <code>STARRED</code> the positions of your point sources. Since your images are plate solved, just open
the best seeing frame with <code>ds9</code> and measure their coordinates. You only have to do it once.</li>
<li>If you are using this as a pipeline, you might want to do the reduction manually once, save the resulting
pixelated background in a <code>.fits</code> or <code>.npy</code> file, and provide it here. </li>
<li>Whether the pipeline attempts to further refine the background. In a scenario where new frames are incoming
regularly, I would set <code>false</code> for this one provided that you did provide a good quality background just above.
I would set <code>true</code> with manual supervision, if the aim is set more on the fitted high-resolution model than auto-updating light curves.</li>
<li>These values should mostly work. Take a look at the loss curve in the plots after running the pipeline to make sure
the optimization converged.</li>
<li>Since our images are already plate solved, this will only execute the post plate solving steps.</li>
</ol>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024, 2025 Frédéric Dux
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>